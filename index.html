<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–î–Ω–µ–≤–Ω–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <meta name="theme-color" content="#FF6B35">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- ==================== –°–¢–†–ê–ù–ò–¶–ê: –¢–†–ï–ù–ò–†–û–í–ö–ê ==================== -->
    <section id="page-workout" class="page active">
        <div class="header">
            <div class="header-greeting" id="header-date">–°–µ–≥–æ–¥–Ω—è</div>
            <div class="header-title">–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div>
        </div>

        <div class="container">
            <!-- –î–∞—Ç–∞ -->
            <div class="date-picker" onclick="openDatePicker()">
                <div class="date-picker-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                </div>
                <div class="date-picker-text">
                    <div class="date-picker-label">–î–∞—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
                    <div class="date-picker-value" id="workout-date-display">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 9 –¥–µ–∫–∞–±—Ä—è</div>
                </div>
                <input type="date" id="workout-date" style="position: absolute; opacity: 0; width: 0;">
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π -->
            <div id="exercises-container">
                <!-- –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>

            <!-- –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ -->
            <button class="btn btn-secondary" onclick="showAddExerciseModal()" style="margin-bottom: 16px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
            </button>

            <!-- –ó–∞–≤–µ—Ä—à–∏—Ç—å -->
            <button class="btn btn-primary" onclick="saveWorkout()" id="save-workout-btn" style="display: none;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 6L9 17l-5-5"/>
                </svg>
                –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
            </button>
        </div>
    </section>

    <!-- ==================== –°–¢–†–ê–ù–ò–¶–ê: –ò–°–¢–û–†–ò–Ø ==================== -->
    <section id="page-history" class="page">
        <div class="header">
            <div class="header-title">–ò—Å—Ç–æ—Ä–∏—è</div>
        </div>

        <div class="container">
            <div id="history-container">
                <div class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
            </div>
        </div>
    </section>

    <!-- ==================== –°–¢–†–ê–ù–ò–¶–ê: –°–¢–ê–¢–ò–°–¢–ò–ö–ê ==================== -->
    <section id="page-stats" class="page">
        <div class="header">
            <div class="header-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        </div>

        <div class="container">
            <div class="form-group">
                <select id="stats-exercise-select" onchange="loadStats()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ...</option>
                </select>
            </div>

            <div id="stats-container" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card highlight">
                        <div class="stat-icon">üèÜ</div>
                        <div class="stat-value" id="stat-max-weight">0 –∫–≥</div>
                        <div class="stat-label">–ú–∞–∫—Å. –≤–µ—Å</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="stat-total-sets">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üîÑ</div>
                        <div class="stat-value" id="stat-total-reps">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üóì</div>
                        <div class="stat-value" id="stat-last-date">‚Äî</div>
                        <div class="stat-label">–ü–æ—Å–ª–µ–¥–Ω—è—è</div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">–ü—Ä–æ–≥—Ä–µ—Å—Å –≤–µ—Å–∞</div>
                    <canvas id="weight-chart"></canvas>
                </div>
            </div>

            <div id="stats-empty" class="empty-state">
                –í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            </div>
        </div>
    </section>

    <!-- ==================== –°–¢–†–ê–ù–ò–¶–ê: –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø ==================== -->
    <section id="page-exercises" class="page">
        <div class="header">
            <div class="header-title">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</div>
        </div>

        <div class="container" id="exercises-list-container">
            <div class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π...</div>
        </div>
    </section>

    <!-- ==================== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –í–´–ë–û–† –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø ==================== -->
    <div id="add-exercise-modal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h2>
                <button class="btn-icon" onclick="hideAddExerciseModal()">√ó</button>
            </div>
            <div class="modal-body" id="exercise-select-list">
                <!-- –°–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π -->
            </div>
        </div>
    </div>

    <!-- ==================== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –¢–ê–ô–ú–ï–† ==================== -->
    <div id="timer-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-title">–û—Ç–¥—ã—Ö</div>
            <div class="timer-circle">
                <svg class="timer-svg" width="200" height="200">
                    <circle class="timer-bg" cx="100" cy="100" r="90" />
                    <circle class="timer-progress" id="timer-progress" cx="100" cy="100" r="90" />
                </svg>
                <div class="timer-display" id="timer-display">02:00</div>
            </div>
            <div class="timer-controls">
                <button class="btn btn-secondary btn-small" onclick="addTimerTime(15)">+15 —Å–µ–∫</button>
                <button class="btn btn-primary btn-small" onclick="stopTimer()">–ì–æ—Ç–æ–≤–æ</button>
            </div>
        </div>
    </div>

    <!-- ==================== –ù–ê–í–ò–ì–ê–¶–ò–Ø ==================== -->
    <nav class="nav">
        <button class="nav-btn active" onclick="showPage('workout')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
            </svg>
            –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
        </button>
        <button class="nav-btn" onclick="showPage('history')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 8v4l3 3"/>
                <circle cx="12" cy="12" r="10"/>
            </svg>
            –ò—Å—Ç–æ—Ä–∏—è
        </button>
        <button class="nav-btn" onclick="showPage('stats')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 20V10M12 20V4M6 20v-6"/>
            </svg>
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        </button>
        <button class="nav-btn" onclick="showPage('exercises')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
            –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        </button>
    </nav>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- API -->
    <script src="js/api.js"></script>

    <!-- –ì–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç -->
    <script>
        // ============================================
        // –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // ============================================
        let exercises = [];
        let currentWorkout = []; // –ú–∞—Å—Å–∏–≤ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π —Ç–µ–∫—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
        let workoutDate = new Date().toISOString().split('T')[0];
        let weightChart = null;
        let lastWorkoutData = {}; // –ö—ç—à –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º

        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É
            document.getElementById('workout-date').value = workoutDate;
            updateDateDisplay();

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            await loadExercises();

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
            await loadLastWorkoutData();

            // –°–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
            document.getElementById('loading').classList.add('hidden');
        });

        /**
         * –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫–∞–∂–¥–æ–º—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é
         */
        async function loadLastWorkoutData() {
            try {
                const workouts = await API.getWorkouts();

                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º, –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ
                workouts.forEach(w => {
                    if (!lastWorkoutData[w.exercise_id]) {
                        lastWorkoutData[w.exercise_id] = {
                            sets: []
                        };
                    }
                });

                // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å–æ–±–∏—Ä–∞–µ–º –ø–æ–¥—Ö–æ–¥—ã –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
                const byExerciseAndDate = {};
                workouts.forEach(w => {
                    const key = w.exercise_id + '_' + w.date;
                    if (!byExerciseAndDate[key]) {
                        byExerciseAndDate[key] = {
                            exercise_id: w.exercise_id,
                            date: w.date,
                            sets: []
                        };
                    }
                    byExerciseAndDate[key].sets.push({
                        weight: w.weight,
                        reps: w.reps
                    });
                });

                // –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                Object.values(byExerciseAndDate).forEach(item => {
                    const existing = lastWorkoutData[item.exercise_id];
                    if (!existing || !existing.date || new Date(item.date) > new Date(existing.date)) {
                        lastWorkoutData[item.exercise_id] = {
                            date: item.date,
                            sets: item.sets.sort((a, b) => a.set_number - b.set_number)
                        };
                    }
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
            }
        }

        /**
         * –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é
         */
        function getLastExerciseData(exerciseId) {
            const data = lastWorkoutData[exerciseId];
            if (data && data.sets && data.sets.length > 0) {
                return data.sets;
            }
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 40 –∫–≥, 10 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
            return [
                { weight: 40, reps: 10 },
                { weight: 40, reps: 10 },
                { weight: 40, reps: 10 }
            ];
        }

        // ============================================
        // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
        // ============================================
        async function loadExercises() {
            try {
                exercises = await API.getExercises();
                renderExercisesList();
                populateStatsSelect();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
            }
        }

        // ============================================
        // –ù–ê–í–ò–ì–ê–¶–ò–Ø
        // ============================================
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            document.getElementById('page-' + pageName).classList.add('active');
            event.target.closest('.nav-btn').classList.add('active');

            window.scrollTo(0, 0);

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            if (pageName === 'history') {
                loadHistory();
            }
        }

        // ============================================
        // –î–ê–¢–ê
        // ============================================
        function openDatePicker() {
            document.getElementById('workout-date').showPicker();
        }

        document.getElementById('workout-date').addEventListener('change', (e) => {
            workoutDate = e.target.value;
            updateDateDisplay();
        });

        function updateDateDisplay() {
            const date = new Date(workoutDate);
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            const formatted = date.toLocaleDateString('ru-RU', options);
            document.getElementById('workout-date-display').textContent = formatted.charAt(0).toUpperCase() + formatted.slice(1);

            // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

            if (workoutDate === today) {
                document.getElementById('header-date').textContent = '–°–µ–≥–æ–¥–Ω—è';
            } else if (workoutDate === yesterday) {
                document.getElementById('header-date').textContent = '–í—á–µ—Ä–∞';
            } else {
                document.getElementById('header-date').textContent = date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
            }
        }

        // ============================================
        // –°–¢–†–ê–ù–ò–¶–ê –¢–†–ï–ù–ò–†–û–í–ö–ò
        // ============================================
        function showAddExerciseModal() {
            const modal = document.getElementById('add-exercise-modal');
            const list = document.getElementById('exercise-select-list');

            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            const byCategory = {};
            exercises.forEach(ex => {
                if (!byCategory[ex.category]) {
                    byCategory[ex.category] = [];
                }
                byCategory[ex.category].push(ex);
            });

            // –û—Ç–¥–µ–ª—å–Ω–æ –±–∞–∑–æ–≤—ã–µ –∏ –∏–∑–æ–ª–∏—Ä—É—é—â–∏–µ
            const baseCategories = ['–ì—Ä—É–¥—å', '–°–ø–∏–Ω–∞', '–ü–ª–µ—á–∏', '–ù–æ–≥–∏'];

            let html = '<div class="section-title">–ë–∞–∑–æ–≤—ã–µ</div>';
            baseCategories.forEach(cat => {
                if (byCategory[cat]) {
                    html += `<div class="category-section">
                        <div class="category-title">${cat}</div>
                        <div class="exercises-grid">
                            ${byCategory[cat].filter(e => e.type === 'base').map(ex => `
                                <button class="exercise-tag" onclick="addExerciseToWorkout('${ex.id}')">
                                    <div class="exercise-tag-icon">${getExerciseIcon(ex.category)}</div>
                                    ${ex.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>`;
                }
            });

            html += '<div class="section-title" style="margin-top: 24px;">–ò–∑–æ–ª–∏—Ä—É—é—â–∏–µ</div>';
            Object.entries(byCategory).forEach(([cat, exs]) => {
                const isolations = exs.filter(e => e.type === 'isolation' || e.type === 'custom');
                if (isolations.length > 0) {
                    html += `<div class="category-section">
                        <div class="category-title">${cat}</div>
                        <div class="exercises-grid">
                            ${isolations.map(ex => `
                                <button class="exercise-tag" onclick="addExerciseToWorkout('${ex.id}')">
                                    <div class="exercise-tag-icon">${getExerciseIcon(ex.category)}</div>
                                    ${ex.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>`;
                }
            });

            list.innerHTML = html;
            modal.classList.remove('hidden');
        }

        function hideAddExerciseModal() {
            document.getElementById('add-exercise-modal').classList.add('hidden');
        }

        function getExerciseIcon(category) {
            const icons = {
                '–ì—Ä—É–¥—å': 'üí™',
                '–°–ø–∏–Ω–∞': 'üèãÔ∏è',
                '–ü–ª–µ—á–∏': 'üéØ',
                '–ù–æ–≥–∏': 'ü¶µ',
                '–ë–∏—Ü–µ–ø—Å': 'üí™',
                '–¢—Ä–∏—Ü–µ–ø—Å': 'üí™',
                '–ò–∫—Ä—ã': 'ü¶∂',
                '–ö–æ—Ä': 'üßò'
            };
            return icons[category] || 'üèãÔ∏è';
        }

        function addExerciseToWorkout(exerciseId) {
            const exercise = exercises.find(e => e.id === exerciseId);
            if (!exercise) return;

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –ø—Ä–æ—à–ª–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
            const lastData = getLastExerciseData(exerciseId);

            // –î–æ–±–∞–≤–ª—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —Å 3 –ø–æ–¥—Ö–æ–¥–∞–º–∏ (–¥–∞–Ω–Ω—ã–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            const sets = [];
            for (let i = 0; i < 3; i++) {
                if (lastData[i]) {
                    sets.push({
                        weight: lastData[i].weight || 40,
                        reps: lastData[i].reps || 10
                    });
                } else {
                    // –ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –º–µ–Ω—å—à–µ 3 –ø–æ–¥—Ö–æ–¥–æ–≤, –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç
                    const lastKnown = lastData[lastData.length - 1] || { weight: 40, reps: 10 };
                    sets.push({
                        weight: lastKnown.weight || 40,
                        reps: lastKnown.reps || 10
                    });
                }
            }

            currentWorkout.push({
                exercise: exercise,
                sets: sets
            });

            renderCurrentWorkout();
            hideAddExerciseModal();
        }

        function renderCurrentWorkout() {
            const container = document.getElementById('exercises-container');

            if (currentWorkout.length === 0) {
                container.innerHTML = '<div class="empty-state">–î–æ–±–∞–≤—å—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</div>';
                document.getElementById('save-workout-btn').style.display = 'none';
                return;
            }

            document.getElementById('save-workout-btn').style.display = 'flex';

            container.innerHTML = currentWorkout.map((item, exIndex) => `
                <div class="exercise-card">
                    <div class="exercise-card-header">
                        <div class="exercise-icon">${getExerciseIcon(item.exercise.category)}</div>
                        <div class="exercise-info">
                            <div class="exercise-name">${item.exercise.name}</div>
                            <div class="exercise-category">${item.exercise.category}</div>
                        </div>
                        <button class="btn-icon danger" onclick="removeExercise(${exIndex})">√ó</button>
                    </div>
                    <div class="exercise-card-body">
                        <div class="sets-header">
                            <span></span>
                            <span>–í–µ—Å</span>
                            <span>–ü–æ–≤—Ç–æ—Ä—ã</span>
                            <span></span>
                        </div>
                        ${item.sets.map((set, setIndex) => `
                            <div class="set-row">
                                <span class="set-num">${setIndex + 1}</span>
                                <input type="number" class="set-input" placeholder="–∫–≥" value="${set.weight}"
                                    onchange="updateSet(${exIndex}, ${setIndex}, 'weight', this.value)">
                                <input type="number" class="set-input" placeholder="0" value="${set.reps}"
                                    onchange="updateSet(${exIndex}, ${setIndex}, 'reps', this.value)">
                                <button class="btn-icon danger" style="width:32px;height:32px;"
                                    onclick="removeSet(${exIndex}, ${setIndex})" ${item.sets.length === 1 ? 'disabled' : ''}>√ó</button>
                            </div>
                        `).join('')}
                        <button class="add-set-btn" onclick="addSet(${exIndex})">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥
                        </button>
                        <button class="timer-btn" onclick="startTimer()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            –¢–∞–π–º–µ—Ä –æ—Ç–¥—ã—Ö–∞ ¬∑ 2:00
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateSet(exIndex, setIndex, field, value) {
            currentWorkout[exIndex].sets[setIndex][field] = value;
        }

        function addSet(exIndex) {
            currentWorkout[exIndex].sets.push({ weight: '', reps: '' });
            renderCurrentWorkout();
        }

        function removeSet(exIndex, setIndex) {
            if (currentWorkout[exIndex].sets.length > 1) {
                currentWorkout[exIndex].sets.splice(setIndex, 1);
                renderCurrentWorkout();
            }
        }

        function removeExercise(exIndex) {
            currentWorkout.splice(exIndex, 1);
            renderCurrentWorkout();
        }

        async function saveWorkout() {
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ–¥—Ö–æ–¥—ã
            const workouts = [];

            currentWorkout.forEach(item => {
                item.sets.forEach((set, index) => {
                    const weight = parseFloat(set.weight) || 0;
                    const reps = parseInt(set.reps) || 0;

                    if (weight > 0 || reps > 0) {
                        workouts.push({
                            date: workoutDate,
                            exercise_id: item.exercise.id,
                            exercise_name: item.exercise.name,
                            set_number: index + 1,
                            weight: weight,
                            reps: reps
                        });
                    }
                });
            });

            if (workouts.length === 0) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥');
                return;
            }

            try {
                document.getElementById('loading').classList.remove('hidden');
                await API.addWorkouts(workouts);

                alert('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
                currentWorkout = [];
                renderCurrentWorkout();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // ============================================
        // –¢–ê–ô–ú–ï–†
        // ============================================
        let timerSeconds = 120;
        let timerInterval = null;
        let timerTotal = 120;

        function startTimer(seconds = 120) {
            timerSeconds = seconds;
            timerTotal = seconds;
            document.getElementById('timer-modal').classList.remove('hidden');
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();

                if (timerSeconds <= 0) {
                    stopTimer();
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                    playBeep();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            document.getElementById('timer-modal').classList.add('hidden');
        }

        function addTimerTime(seconds) {
            timerSeconds += seconds;
            timerTotal += seconds;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const mins = Math.floor(timerSeconds / 60);
            const secs = timerSeconds % 60;
            document.getElementById('timer-display').textContent =
                mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');

            // –û–±–Ω–æ–≤–∏—Ç—å –∫—Ä—É–≥–æ–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å
            const progress = document.getElementById('timer-progress');
            const circumference = 2 * Math.PI * 90;
            const offset = circumference - (timerSeconds / timerTotal) * circumference;
            progress.style.strokeDasharray = circumference;
            progress.style.strokeDashoffset = offset;
        }

        function playBeep() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 800;
            gain.gain.value = 0.3;
            osc.start();
            setTimeout(() => osc.stop(), 200);
        }

        // ============================================
        // –ò–°–¢–û–†–ò–Ø
        // ============================================
        async function loadHistory() {
            const container = document.getElementById('history-container');

            try {
                const workouts = await API.getWorkouts();

                if (workouts.length === 0) {
                    container.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
                    return;
                }

                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ –∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é
                const grouped = {};
                workouts.forEach(w => {
                    const dateKey = w.date;
                    if (!grouped[dateKey]) {
                        grouped[dateKey] = {};
                    }
                    if (!grouped[dateKey][w.exercise_id]) {
                        grouped[dateKey][w.exercise_id] = {
                            name: w.exercise_name,
                            sets: []
                        };
                    }
                    grouped[dateKey][w.exercise_id].sets.push({
                        weight: w.weight,
                        reps: w.reps
                    });
                });

                // –†–µ–Ω–¥–µ—Ä
                let html = '';
                const dates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

                dates.forEach(dateKey => {
                    const date = new Date(dateKey);
                    const today = new Date().toISOString().split('T')[0];
                    const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

                    let dateLabel;
                    if (dateKey === today) {
                        dateLabel = '–°–µ–≥–æ–¥–Ω—è';
                    } else if (dateKey === yesterday) {
                        dateLabel = '–í—á–µ—Ä–∞';
                    } else {
                        dateLabel = date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
                    }

                    html += `<div class="history-group">
                        <div class="history-date">${dateLabel}</div>`;

                    Object.values(grouped[dateKey]).forEach(ex => {
                        const exerciseData = exercises.find(e => e.name === ex.name);
                        const icon = exerciseData ? getExerciseIcon(exerciseData.category) : 'üèãÔ∏è';

                        html += `
                            <div class="history-card">
                                <div class="history-icon">${icon}</div>
                                <div class="history-info">
                                    <div class="history-exercise">${ex.name}</div>
                                    <div class="history-details">${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤</div>
                                    <div class="history-sets">
                                        ${ex.sets.map(s => `<span class="history-set">${s.weight}–∫–≥ √ó ${s.reps}</span>`).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                });

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        // ============================================
        // –°–¢–ê–¢–ò–°–¢–ò–ö–ê
        // ============================================
        function populateStatsSelect() {
            const select = document.getElementById('stats-exercise-select');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ...</option>';

            exercises.forEach(ex => {
                const option = document.createElement('option');
                option.value = ex.id;
                option.textContent = ex.name;
                select.appendChild(option);
            });
        }

        async function loadStats() {
            const select = document.getElementById('stats-exercise-select');
            const exerciseId = select.value;

            if (!exerciseId) {
                document.getElementById('stats-container').style.display = 'none';
                document.getElementById('stats-empty').style.display = 'block';
                return;
            }

            try {
                const stats = await API.getStats(exerciseId);

                document.getElementById('stat-max-weight').textContent = stats.maxWeight + ' –∫–≥';
                document.getElementById('stat-total-sets').textContent = stats.totalSets;
                document.getElementById('stat-total-reps').textContent = stats.totalReps;

                if (stats.lastWorkout) {
                    const date = new Date(stats.lastWorkout.date);
                    document.getElementById('stat-last-date').textContent =
                        date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                } else {
                    document.getElementById('stat-last-date').textContent = '‚Äî';
                }

                // –ì—Ä–∞—Ñ–∏–∫
                renderWeightChart(stats.workouts);

                document.getElementById('stats-container').style.display = 'block';
                document.getElementById('stats-empty').style.display = 'none';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }

        function renderWeightChart(workouts) {
            const ctx = document.getElementById('weight-chart').getContext('2d');

            if (weightChart) {
                weightChart.destroy();
            }

            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–µ—Å –∑–∞ –¥–µ–Ω—å)
            const byDate = {};
            workouts.forEach(w => {
                const date = w.date;
                if (!byDate[date] || w.weight > byDate[date]) {
                    byDate[date] = parseFloat(w.weight) || 0;
                }
            });

            const labels = Object.keys(byDate).map(d =>
                new Date(d).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })
            );
            const data = Object.values(byDate);

            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–í–µ—Å (–∫–≥)',
                        data: data,
                        borderColor: '#FF6B35',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
        }

        // ============================================
        // –°–¢–†–ê–ù–ò–¶–ê –£–ü–†–ê–ñ–ù–ï–ù–ò–ô
        // ============================================
        function renderExercisesList() {
            const container = document.getElementById('exercises-list-container');

            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
            const byCategory = {};
            exercises.forEach(ex => {
                if (!byCategory[ex.category]) {
                    byCategory[ex.category] = [];
                }
                byCategory[ex.category].push(ex);
            });

            const baseCategories = ['–ì—Ä—É–¥—å', '–°–ø–∏–Ω–∞', '–ü–ª–µ—á–∏', '–ù–æ–≥–∏'];

            let html = '<div class="section-title">–ë–∞–∑–æ–≤—ã–µ</div>';
            baseCategories.forEach(cat => {
                if (byCategory[cat]) {
                    const baseExs = byCategory[cat].filter(e => e.type === 'base');
                    if (baseExs.length > 0) {
                        html += `<div class="category-section">
                            <div class="category-title">${cat}</div>
                            <div class="exercises-grid">
                                ${baseExs.map(ex => `
                                    <div class="exercise-tag">
                                        <div class="exercise-tag-icon">${getExerciseIcon(cat)}</div>
                                        ${ex.name}
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    }
                }
            });

            html += '<div class="section-title" style="margin-top: 24px;">–ò–∑–æ–ª–∏—Ä—É—é—â–∏–µ</div>';
            Object.entries(byCategory).forEach(([cat, exs]) => {
                const isolations = exs.filter(e => e.type === 'isolation' || e.type === 'custom');
                if (isolations.length > 0) {
                    html += `<div class="category-section">
                        <div class="category-title">${cat}</div>
                        <div class="exercises-grid">
                            ${isolations.map(ex => `
                                <div class="exercise-tag">
                                    <div class="exercise-tag-icon">${getExerciseIcon(cat)}</div>
                                    ${ex.name}
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                }
            });

            container.innerHTML = html;
        }
    </script>
</body>
</html>
